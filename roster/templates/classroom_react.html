{% extends "base.html" %}

{% block content %}

<div id="classroom-root"></div>

<!-- React and ReactDOM from CDN -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Babel Standalone for JSX transformation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
    .assign-btn {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)) !important;
        border: none !important;
        color: var(--btn-text-color) !important;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .assign-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 15px var(--shadow-color);
    }

    .delete-btn {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 0 4px;
        margin-left: 6px;
        transition: all 0.2s ease;
    }

    .delete-btn:hover {
        color: #ff4444;
        transform: scale(1.2);
    }

    .placement-row {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: var(--menu-bg);
        border: 2px solid var(--primary-color);
        border-radius: 10px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 30px var(--shadow-color);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-title {
        color: var(--primary-color);
        font-size: 1.3rem;
        font-weight: bold;
    }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 1;
    }

    .close-btn:hover {
        color: var(--primary-color);
    }

    .search-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        background-color: var(--input-bg) !important;
        border: 2px solid var(--primary-color) !important;
        color: var(--text-color) !important;
        border-radius: 5px;
    }

    .user-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 15px;
    }

    .user-item {
        padding: 10px;
        margin-bottom: 5px;
        background-color: var(--input-bg);
        border: 1px solid var(--primary-color);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .user-item:hover {
        background-color: var(--input-focus-bg);
        transform: translateX(5px);
    }

    .loading-text {
        color: var(--text-color);
        text-align: center;
        padding: 20px;
    }

    .error-text {
        color: #ff6b6b;
        padding: 10px;
        background-color: rgba(255, 0, 0, 0.1);
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .confirm-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
    }

    .confirm-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
    }

    .confirm-btn-yes {
        background: linear-gradient(45deg, #ff4444, #ff6b6b);
        color: white;
    }

    .confirm-btn-yes:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
    }

    .confirm-btn-no:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 10px var(--shadow-color);
    }

    /* Monitor View Styles */
    .monitor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        padding: 10px;
        background-color: #1a1a1a;
        border-radius: 8px;
    }

    .monitor-card {
        background-color: #000;
        border: 1px solid #333;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        aspect-ratio: 16/9;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .monitor-card:hover {
        border-color: var(--primary-color);
    }

    .monitor-screen {
        width: 100%;
        height: 100%;
        object-fit: contain;
        /* or cover, depending on preference */
        background-color: #000;
    }

    .monitor-screen.stale {
        filter: grayscale(100%) opacity(0.5);
    }

    .monitor-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 5px;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-dot {
        height: 8px;
        width: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .status-dot.active {
        background-color: #00ff00;
        box-shadow: 0 0 5px #00ff00;
    }

    .status-dot.stale {
        background-color: #ffff00;
    }

    .status-dot.missing {
        background-color: #ff0000;
    }

    .view-toggle-btn {
        margin-bottom: 10px;
        width: 100%;
    }

    /* Hover Info Styles */
    .monitor-hover-info {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        padding: 10px;
        text-align: center;
        pointer-events: none;
        z-index: 5;
    }

    .monitor-card:hover .monitor-hover-info {
        opacity: 1;
    }

    .hover-label {
        color: var(--primary-color);
        font-size: 0.7rem;
        text-transform: uppercase;
        margin-top: 5px;
    }

    .hover-value {
        font-size: 0.85rem;
        word-break: break-all;
    }

    /* Single Screenshot Detail Layout */
    .screenshot-details-layout {
        display: flex;
        gap: 20px;
        text-align: left;
    }

    .screenshot-main-view {
        flex: 3;
        display: flex;
        flex-direction: column;
    }

    .screenshot-sidebar {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #333;
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-width: 250px;
    }

    .sidebar-info-block {
        display: flex;
        flex-direction: column;
    }

    .sidebar-info-label {
        color: var(--primary-color);
        font-weight: bold;
        font-size: 0.75rem;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .sidebar-info-value {
        color: #fff;
        font-size: 0.95rem;
        word-break: break-all;
    }
</style>

{% verbatim %}
<script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    function AssignmentModal({ isOpen, onClose, workplaceNumber, onAssign }) {
        const [searchTerm, setSearchTerm] = useState('');
        const [users, setUsers] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        useEffect(() => {
            if (isOpen && searchTerm.length >= 2) {
                const timer = setTimeout(async () => {
                    setLoading(true);
                    try {
                        const response = await fetch(`/search_users_ajax/?surname=${encodeURIComponent(searchTerm)}`);
                        const data = await response.json();
                        setUsers(data);
                        setError(null);
                    } catch (err) {
                        setError('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤');
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                }, 300);
                return () => clearTimeout(timer);
            } else {
                setUsers([]);
            }
        }, [searchTerm, isOpen]);

        const handleAssign = async (user) => {
            try {
                const workplaceId = `329-${workplaceNumber}`;
                const response = await fetch(`/api/classrooms/329/workplaces/${workplaceId}/assign/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: user.id }),
                });

                if (response.ok) {
                    onAssign();
                    onClose();
                    setSearchTerm('');
                } else {
                    const errorData = await response.json();
                    setError(errorData.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è');
                }
            } catch (err) {
                setError('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
                console.error(err);
            }
        };

        if (!isOpen) return null;

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –Ω–∞ Workplace {workplaceNumber}</h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>

                    {error && <div className="error-text">{error}</div>}

                    <input
                        type="text"
                        className="search-input"
                        placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        autoFocus
                    />

                    <div className="user-list">
                        {loading && <div className="loading-text">–ü–æ—à—É–∫...</div>}
                        {!loading && searchTerm.length < 2 && (
                            <div className="loading-text">–í–≤–µ–¥—ñ—Ç—å –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏</div>
                        )}
                        {!loading && users.length === 0 && searchTerm.length >= 2 && (
                            <div className="loading-text">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
                        )}
                        {!loading && users.map((user, idx) => (
                            <div
                                key={idx}
                                className="user-item"
                                onClick={() => handleAssign(user)}
                            >
                                {user.display}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    function ConfirmDeleteModal({ isOpen, onClose, placement, onConfirm }) {
        if (!isOpen || !placement) return null;

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è</h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>

                    <p style={{ color: 'var(--text-color)', marginBottom: '15px' }}>
                        –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è?
                    </p>
                    <p style={{ color: 'var(--primary-color)', fontWeight: 'bold' }}>
                        {placement.user.last_name} {placement.user.first_name}
                    </p>

                    <div className="confirm-buttons">
                        <button className="confirm-btn confirm-btn-no" onClick={onClose}>
                            –°–∫–∞—Å—É–≤–∞—Ç–∏
                        </button>
                        <button className="confirm-btn confirm-btn-yes" onClick={onConfirm}>
                            –í–∏–¥–∞–ª–∏—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    function ScreenshotModal({ isOpen, onClose, workplaceId, classroomData }) {
        const [history, setHistory] = useState([]);
        const [selectedFilename, setSelectedFilename] = useState(null);
        const [loadingHistory, setLoadingHistory] = useState(false);
        const scrollContainerRef = React.useRef(null);

        // Reset state when opening for a new workplace
        useEffect(() => {
            if (isOpen && workplaceId) {
                setLoadingHistory(true);
                fetch(`/api/classrooms/329/workplaces/${workplaceId}/screenshots/`)
                    .then(res => res.json())
                    .then(data => {
                        // Data is now array of objects: {filename, created_at, user_name, os_username, reported_workplace}
                        // Or strings if API outdated (backward compat check)
                        const normalized = data.map(item => {
                            if (typeof item === 'string') return {
                                filename: item,
                                created_at: null,
                                user_name: null,
                                os_username: null,
                                reported_workplace: null
                            };
                            return item;
                        });
                        setHistory(normalized);
                        // Default to latest if available
                        if (normalized && normalized.length > 0) {
                            setSelectedFilename(normalized[0].filename);
                        }
                    })
                    .catch(err => console.error(err))
                    .finally(() => setLoadingHistory(false));
            } else {
                setHistory([]);
                setSelectedFilename(null);
            }
        }, [isOpen, workplaceId]);

        // Auto-update handling: if we are viewing the latest image, switch to the new latest if it arrives
        useEffect(() => {
            if (!isOpen || !workplaceId || !classroomData) return;
            const workplace = [...(classroomData.workplaces_1 || []), ...(classroomData.workplaces_2 || [])]
                .find(w => w.number === workplaceId);

            if (workplace && workplace.last_screenshot_filename) {
                // If we were viewing the previous "latest", or nothing selected, update to new latest
                // Logic: check if the new filename is present in history. If not, refresh history
                const latestInHistory = history.length > 0 ? history[0].filename : null;

                if (latestInHistory !== workplace.last_screenshot_filename) {
                    // Add new item to top of list
                    const newItem = {
                        filename: workplace.last_screenshot_filename,
                        created_at: workplace.last_screenshot_at,
                        user_name: null // will be missing until refresh
                    };

                    setHistory(prev => [newItem, ...prev]);
                    if (selectedFilename === latestInHistory) {
                        setSelectedFilename(workplace.last_screenshot_filename);
                    }
                }
            }
        }, [classroomData, isOpen, workplaceId]);


        if (!isOpen || !workplaceId || !classroomData) return null;

        // Find the workplace object from the fresh data
        const workplace = [...(classroomData.workplaces_1 || []), ...(classroomData.workplaces_2 || [])]
            .find(w => w.number === workplaceId);

        if (!workplace) return null;

        // Determine which file to show
        const filenameToShow = selectedFilename || workplace.last_screenshot_filename;

        // Find metadata for selected file
        const selectedMeta = history.find(h => h.filename === filenameToShow) || {};
        const userName = selectedMeta.user_name;

        // If still no filename (never uploaded), show NO SIGNAL
        if (!filenameToShow) {
            return (
                <div className="modal show" onClick={onClose}>
                    <div className="modal-content" style={{ maxWidth: '900px', width: '95%' }} onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3 className="modal-title">–°–∫—Ä—ñ–Ω—à–æ—Ç Workplace {workplace.number}</h3>
                            <button className="close-btn" onClick={onClose}>&times;</button>
                        </div>
                        <div className="text-center p-5 font-weight-bold text-danger">NO SIGNAL (No Data)</div>
                    </div>
                </div>
            );
        }

        // Parse timestamp from filename: YYYYMMDD_HHMMSS.png
        // If it matches that pattern, use it. Otherwise fall back to last_screenshot_at if it's the latest file.
        let timestamp;
        if (selectedMeta.created_at) {
            timestamp = new Date(selectedMeta.created_at);
        } else {
            const match = filenameToShow.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})\.png$/);
            if (match) {
                timestamp = new Date(
                    parseInt(match[1]),
                    parseInt(match[2]) - 1,
                    parseInt(match[3]),
                    parseInt(match[4]),
                    parseInt(match[5]),
                    parseInt(match[6])
                );
            } else if (filenameToShow === workplace.last_screenshot_filename) {
                timestamp = new Date(workplace.last_screenshot_at);
            } else {
                timestamp = new Date(); // Fallback
            }
        }


        // Calculate status for modal (same logic as MonitorView)
        // Only apply "Lost" logic if we are viewing the LATEST file
        const isLatest = filenameToShow === workplace.last_screenshot_filename;
        const age = new Date() - timestamp;
        const isLost = isLatest && (age > 12 * 60 * 60 * 1000); // > 12 hours
        const isStale = age > 15 * 60 * 1000;     // > 15 mins

        let statusClass = 'active';
        if (isLost) statusClass = 'missing';
        else if (isStale) statusClass = 'stale';

        const displayImage = true; // Always display image in modal, even if signal is lost
        const imageUrl = `/api/classrooms/329/workplaces/${workplace.number}/screenshots/${filenameToShow}/`;

        // Helper to scroll horizontal list

        // Helper to Format Time
        const formatTimeShort = (date) => {
            return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
        };

        // Helper to calculate "time ago"
        const getTimeAgo = (date) => {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + " years ago";
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + " months ago";
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + " days ago";
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + " hours ago";
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + " mins ago";
            return Math.floor(seconds) + " seconds ago";
        };

        const timeAgo = getTimeAgo(timestamp);

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" style={{ maxWidth: '900px', width: '95%' }} onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">
                            <span className={`status-dot ${statusClass}`} style={{ marginRight: '10px' }}></span>
                            –°–∫—Ä—ñ–Ω—à–æ—Ç {workplace.number}
                        </h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>
                    <div className="screenshot-details-layout">
                        <div className="screenshot-main-view">
                            <div className="text-center mb-2 text-muted">
                                {timestamp.toLocaleString('uk-UA')} ({timeAgo})
                            </div>
                            <div style={{ textAlign: 'center', backgroundColor: '#000', minHeight: '300px', display: 'flex', flexDirection: 'column' }}>
                                <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', overflow: 'hidden', padding: '10px' }}>
                                    {displayImage ? (
                                        <img
                                            src={imageUrl}
                                            alt={`Screenshot ${workplace.number}`}
                                            style={{ maxWidth: '100%', maxHeight: '60vh', border: '1px solid #333' }}
                                        />
                                    ) : (
                                        <div style={{
                                            color: '#ff0000',
                                            fontWeight: 'bold',
                                            fontSize: '1.5rem',
                                        }}>
                                            NO SIGNAL
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="screenshot-sidebar">
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">Workplace</span>
                                <span className="sidebar-info-value">{selectedMeta.reported_workplace || workplace.last_reported_workplace || workplace.number}</span>
                            </div>
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">OS User</span>
                                <span className="sidebar-info-value">{selectedMeta.os_username || workplace.last_os_username || 'Unknown'}</span>
                            </div>
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">Student</span>
                                <span className="sidebar-info-value">{userName || (workplace.placements && workplace.placements.length > 0 ? `${workplace.placements[0].user.last_name} ${workplace.placements[0].user.first_name}` : 'Unknown')}</span>
                            </div>
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">Captured</span>
                                <span className="sidebar-info-value">{timestamp.toLocaleString('uk-UA')}</span>
                            </div>
                        </div>
                    </div>

                    <div style={{
                        height: '100px',
                        borderTop: '1px solid #333',
                        overflowX: 'auto',
                        whiteSpace: 'nowrap',
                        padding: '10px',
                        textAlign: 'left',
                        display: 'flex',
                        gap: '10px'
                    }} ref={scrollContainerRef}>
                        {history.map(item => {
                            const fname = item.filename;
                            let d;
                            if (item.created_at) {
                                d = new Date(item.created_at);
                            } else {
                                const m = fname.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})\.png$/);
                                if (!m) return null;
                                d = new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]), parseInt(m[4]), parseInt(m[5]), parseInt(m[6]));
                            }

                            const isSelected = fname === filenameToShow;

                            return (
                                <div
                                    key={fname}
                                    onClick={() => setSelectedFilename(fname)}
                                    style={{
                                        display: 'inline-block',
                                        cursor: 'pointer',
                                        border: isSelected ? '2px solid var(--primary-color)' : '1px solid #444',
                                        borderRadius: '4px',
                                        overflow: 'hidden',
                                        position: 'relative',
                                        minWidth: '120px',
                                        height: '100%',
                                        opacity: isSelected ? 1 : 0.7
                                    }}
                                    title={item.user_name || 'No user info'}
                                >
                                    <img
                                        src={`/api/classrooms/329/workplaces/${workplace.number}/screenshots/${fname}/`}
                                        alt={fname}
                                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                    />
                                    <div style={{
                                        position: 'absolute',
                                        bottom: 0,
                                        left: 0,
                                        right: 0,
                                        background: 'rgba(0,0,0,0.7)',
                                        color: '#fff',
                                        fontSize: '10px',
                                        padding: '2px',
                                        textAlign: 'center'
                                    }}>
                                        {formatTimeShort(d)}
                                        {item.user_name && <div style={{ fontSize: '9px', color: '#ccc', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '100%' }}>{item.user_name}</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        );
    }

    function MonitorView({ workplaces, onScreenshotClick }) {
        // Sort workplaces by number to ensure 1-18 order
        const sortedWorkplaces = [...workplaces].sort((a, b) => a.number - b.number);

        // Fill in missing workplaces if needed (assuming 1-18 range)
        const allWorkplaces = [];
        const existingMap = new Map(sortedWorkplaces.map(w => [w.number, w]));

        for (let i = 1; i <= 18; i++) {
            if (existingMap.has(i)) {
                allWorkplaces.push(existingMap.get(i));
            } else {
                allWorkplaces.push({ number: i, last_screenshot_filename: null });
            }
        }

        return (
            <div className="monitor-container">
                <h3 className="text-center mb-3">–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –µ–∫—Ä–∞–Ω—ñ–≤</h3>
                <div className="monitor-grid">
                    {allWorkplaces.map(wp => {
                        const hasScreenshot = !!wp.last_screenshot_filename;
                        const lastUpdate = wp.last_screenshot_at ? new Date(wp.last_screenshot_at) : null;

                        let statusClass = 'missing'; // Default to missing (Red)
                        let isLost = true;
                        let isStale = false;

                        if (hasScreenshot && lastUpdate) {
                            const age = new Date() - lastUpdate;
                            isLost = age > 12 * 60 * 60 * 1000; // > 12 hours
                            isStale = age > 15 * 60 * 1000;     // > 15 mins

                            if (isLost) {
                                statusClass = 'missing';
                            } else if (isStale) {
                                statusClass = 'stale';
                            } else {
                                statusClass = 'active';
                            }
                        }

                        // Determine if we show the image
                        // We show image only if we have one AND it's not "lost" (>12h)
                        const showImage = hasScreenshot && !isLost;

                        const imageUrl = showImage
                            ? `/api/classrooms/329/workplaces/${wp.number}/screenshots/${wp.last_screenshot_filename}/?t=${lastUpdate ? lastUpdate.getTime() : Date.now()}`
                            : null;

                        return (
                            <div
                                key={wp.number}
                                className="monitor-card"
                                onClick={() => hasScreenshot && onScreenshotClick(wp)}
                                title={hasScreenshot ? `Updated: ${lastUpdate.toLocaleTimeString('uk-UA')}` : 'No Signal'}
                            >
                                {showImage ? (
                                    <img
                                        src={imageUrl}
                                        className={`monitor-screen ${isStale ? 'stale' : ''}`}
                                        alt={`WP ${wp.number}`}
                                    />
                                ) : (
                                    <div className="monitor-screen" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', color: statusClass === 'missing' ? '#ff0000' : '#333', fontWeight: 'bold' }}>
                                        NO SIGNAL
                                    </div>
                                )}
                                {hasScreenshot && (
                                    <div className="monitor-hover-info">
                                        <div className="hover-label">Workspace</div>
                                        <div className="hover-value">{wp.last_reported_workplace || wp.number}</div>
                                        <div className="hover-label">OS User</div>
                                        <div className="hover-value">{wp.last_os_username || 'Unknown'}</div>
                                    </div>
                                )}
                                <div className="monitor-overlay">
                                    <span>
                                        <span className={`status-dot ${statusClass}`}></span>
                                        W-{wp.number}
                                    </span>
                                    {lastUpdate && <span>{lastUpdate.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })}</span>}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    }

    function ClassroomApp() {
        const [classroomData, setClassroomData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [lastUpdated, setLastUpdated] = useState(null);

        // Filter state
        const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
        const [lesson, setLesson] = useState(null); // Will be fetched from server
        const [singles, setSingles] = useState(false);
        const [autoUpdate, setAutoUpdate] = useState(true); // Auto-update lesson
        const [screenshotsEnabled, setScreenshotsEnabled] = useState(true); // Screenshots toggle
        const [viewMode, setViewMode] = useState('list'); // 'list' or 'monitor'

        // Modal state
        const [modalOpen, setModalOpen] = useState(false);
        const [selectedWorkplace, setSelectedWorkplace] = useState(null);
        const [deleteModalOpen, setDeleteModalOpen] = useState(false);
        const [placementToDelete, setPlacementToDelete] = useState(null);
        const [screenshotModalOpen, setScreenshotModalOpen] = useState(false);
        const [screenshotWorkplaceId, setScreenshotWorkplaceId] = useState(null);

        const REFRESH_INTERVAL = 5000; // 5 seconds

        // Get current lesson from server on initial load
        useEffect(() => {
            const getCurrentLesson = async () => {
                if (!autoUpdate) {
                    // If auto-update is disabled, use fallback
                    if (!lesson) setLesson('1');
                    return;
                }

                try {
                    const response = await fetch('/api/classrooms/329/');
                    if (response.ok) {
                        const data = await response.json();
                        let lessonNum = data.lesson; // 1-based

                        // Initial load is usually paired mode (singles default false)
                        if (!singles && lessonNum % 2 === 0) {
                            lessonNum = lessonNum - 1;
                        }

                        const lessonIndex = Math.max(1, lessonNum);
                        setLesson(lessonIndex.toString());
                    } else {
                        setLesson('1'); // Fallback
                    }
                } catch (err) {
                    console.error('Error fetching current lesson:', err);
                    setLesson('1'); // Fallback
                }
            };
            getCurrentLesson();
        }, [autoUpdate]);

        // Adjust lesson when switching between paired/single mode
        useEffect(() => {
            if (!lesson) return;

            const lessonNum = parseInt(lesson);
            if (!singles && lessonNum % 2 === 0) {
                // Switching to paired mode and current lesson is even (2,4,6,8)
                // Round down to the paired lesson (1,3,5,7)
                setLesson((lessonNum - 1).toString());
            }
        }, [singles]);

        const fetchClassroomData = useCallback(async () => {
            if (!lesson) return; // Don't fetch until lesson is initialized

            try {
                const params = new URLSearchParams({
                    date: date,
                    lesson: lesson,
                    singles: singles ? 'on' : 'off'
                });

                const response = await fetch(`/api/classrooms/329/?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                setClassroomData(data);
                setLastUpdated(new Date());
                setError(null);

                // Auto-update lesson if enabled and lesson has changed
                if (autoUpdate && data.lesson !== undefined) {
                    let lessonNum = data.lesson; // 1-based

                    // Sort of redundant now as backend does logic, but good for safety
                    // If in paired mode (default), pairs start at odd numbers (1, 3, 5...)
                    // So if we get an even number (2, 4...), round down to the pair start
                    if (!singles && lessonNum % 2 === 0) {
                        lessonNum = lessonNum - 1;
                    }

                    // Use 1-based index directly
                    if (lessonNum.toString() !== lesson) {
                        setLesson(lessonNum.toString());
                    }
                }

                // Update screenshots state from server 
                if (data.screenshots_enabled !== undefined) {
                    setScreenshotsEnabled(data.screenshots_enabled);
                }
            } catch (err) {
                setError(err.message);
                console.error('Error fetching classroom data:', err);
            } finally {
                setLoading(false);
            }
        }, [date, lesson, singles, autoUpdate]);

        // Initial fetch and auto-refresh
        useEffect(() => {
            fetchClassroomData();
            const interval = setInterval(fetchClassroomData, REFRESH_INTERVAL);
            return () => clearInterval(interval);
        }, [fetchClassroomData]);

        const handleScreenshotClick = (workplace) => {
            setScreenshotWorkplaceId(workplace.number);
            setScreenshotModalOpen(true);
        };

        const handleCloseScreenshotModal = () => {
            setScreenshotModalOpen(false);
            setScreenshotWorkplaceId(null);
        };

        const handleViewModeToggle = () => {
            setViewMode(prev => prev === 'list' ? 'monitor' : 'list');
        };

        const getAllWorkplaces = () => {
            if (!classroomData) return [];
            return [
                ...(classroomData.workplaces_1 || []),
                ...(classroomData.workplaces_2 || [])
            ];
        };

        const formatTime = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
        };

        const formatLastUpdated = () => {
            if (!lastUpdated) return '';
            return lastUpdated.toLocaleTimeString('uk-UA', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        };

        const handleOpenModal = (workplaceNumber) => {
            setSelectedWorkplace(workplaceNumber);
            setModalOpen(true);
        };

        const handleCloseModal = () => {
            setModalOpen(false);
            setSelectedWorkplace(null);
        };

        const handleAssignSuccess = () => {
            fetchClassroomData();
        };

        const handleDeleteClick = (placement) => {
            setPlacementToDelete(placement);
            setDeleteModalOpen(true);
        };

        const handleDeleteConfirm = async () => {
            if (!placementToDelete) return;

            try {
                const response = await fetch(
                    `/api/classrooms/329/workplaces/${placementToDelete.workplace_id}/?placement_id=${placementToDelete.id}`,
                    { method: 'DELETE' }
                );

                if (response.ok) {
                    fetchClassroomData();
                    setDeleteModalOpen(false);
                    setPlacementToDelete(null);
                } else {
                    const errorData = await response.json();
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + (errorData.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
                }
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + err.message);
                console.error(err);
            }
        };

        const handleDeleteCancel = () => {
            setDeleteModalOpen(false);
            setPlacementToDelete(null);
        };

        const handleScreenshotsToggle = async (enabled) => {
            try {
                const response = await fetch('/api/classrooms/329/screenshots/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ screenshots_enabled: enabled }),
                });

                if (response.ok) {
                    setScreenshotsEnabled(enabled);
                } else {
                    console.error('Failed to update screenshots setting');
                    // Revert on error
                    setScreenshotsEnabled(!enabled);
                }
            } catch (err) {
                console.error('Error updating screenshots setting:', err);
                // Revert on error
                setScreenshotsEnabled(!enabled);
            }
        };

        // Helper for rendering workplace card (to deduplicate code)
        const renderWorkplaceCard = (workplace) => (
            <div key={workplace.number} className="card text-center border-success mt-2">
                <div className="card-body pt-1 pb-1">
                    <h5 className="card-title" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '0' }}>
                        <span>Workplace {workplace.number}</span>
                        <div>
                            {workplace.last_screenshot_filename && (
                                <button
                                    className="assign-btn"
                                    onClick={() => handleScreenshotClick(workplace)}
                                    title={`–°–∫—Ä—ñ–Ω—à–æ—Ç: ${formatTime(workplace.last_screenshot_at)}`}
                                    style={{ padding: '2px 6px', fontSize: '12px', marginLeft: '4px', background: 'linear-gradient(45deg, #17a2b8, #138496)' }}
                                >
                                    üì∑
                                </button>
                            )}
                            <button
                                className="assign-btn"
                                onClick={() => handleOpenModal(workplace.number)}
                                title="–î–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞"
                                style={{ padding: '2px 6px', fontSize: '12px', marginLeft: '4px' }}
                            >
                                ‚ûï
                            </button>
                        </div>
                    </h5>
                    {workplace.placements.map(placement => (
                        <div key={placement.id} className="placement-row">
                            <span>
                                {placement.user.last_name} {placement.user.first_name}{' '}
                                <span className="text-success">
                                    {formatTime(placement.created_at)}
                                </span>
                            </span>
                            <button
                                className="delete-btn"
                                onClick={() => handleDeleteClick(placement)}
                                title="–í–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è"
                            >
                                ‚ùå
                            </button>
                            <br />
                        </div>
                    ))}
                </div>
            </div>
        );

        return (
            <div className="container mt-3">
                <AssignmentModal
                    isOpen={modalOpen}
                    onClose={handleCloseModal}
                    workplaceNumber={selectedWorkplace}
                    onAssign={handleAssignSuccess}
                />

                <ConfirmDeleteModal
                    isOpen={deleteModalOpen}
                    onClose={handleDeleteCancel}
                    placement={placementToDelete}
                    onConfirm={handleDeleteConfirm}
                />

                <ScreenshotModal
                    isOpen={screenshotModalOpen}
                    onClose={handleCloseScreenshotModal}
                    workplaceId={screenshotWorkplaceId}
                    classroomData={classroomData}
                />

                {/* Filters */}
                <div className="row mb-4 g-3">
                    {/* ... (filters same) ... */}
                    <div className="col-md-2">
                        <label htmlFor="dateFilter" className="form-label">–û–±—Ä–∞—Ç–∏ –¥–∞—Ç—É:</label>
                        <input
                            type="date"
                            id="dateFilter"
                            className="form-control"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                        />

                        <label htmlFor="lessonFilter" className="form-label mt-2">–£—Ä–æ–∫:</label>
                        <select
                            id="lessonFilter"
                            className="form-select"
                            value={lesson}
                            onChange={(e) => setLesson(e.target.value)}
                        >
                            {singles
                                ? [1, 2, 3, 4, 5, 6, 7, 8].map(num => (
                                    <option key={num} value={num}>{num} —É—Ä–æ–∫</option>
                                ))
                                : [1, 3, 5, 7].map(num => (
                                    <option key={num} value={num}>{num}-{num + 1} —É—Ä–æ–∫–∏</option>
                                ))
                            }
                        </select>

                        <div className="form-check mt-2">
                            <input
                                type="checkbox"
                                id="pairFilter"
                                className="form-check-input"
                                checked={singles}
                                onChange={(e) => setSingles(e.target.checked)}
                            />
                            <label htmlFor="pairFilter" className="form-check-label">
                                –û–¥–∏–Ω–æ—á–Ω—ñ —É—Ä–æ–∫–∏
                            </label>
                        </div>

                        <div className="form-check mt-2">
                            <input
                                type="checkbox"
                                id="autoUpdateFilter"
                                className="form-check-input"
                                checked={!autoUpdate}
                                onChange={(e) => setAutoUpdate(!e.target.checked)}
                            />
                            <label htmlFor="autoUpdateFilter" className="form-check-label">
                                –ù–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏
                            </label>
                        </div>

                        <div className="form-check mt-2">
                            <input
                                type="checkbox"
                                id="screenshotsFilter"
                                className="form-check-input"
                                checked={screenshotsEnabled}
                                onChange={(e) => handleScreenshotsToggle(e.target.checked)}
                            />
                            <label htmlFor="screenshotsFilter" className="form-check-label">
                                –°–∫—Ä—ñ–Ω—à–æ—Ç–∏ —É–≤—ñ–º–∫–Ω–µ–Ω—ñ
                            </label>
                        </div>

                        <hr />

                        <button
                            className={`btn ${viewMode === 'monitor' ? 'btn-primary' : 'btn-outline-primary'} view-toggle-btn`}
                            onClick={handleViewModeToggle}
                        >
                            {viewMode === 'monitor' ? 'üìã –°–ø–∏—Å–æ–∫' : 'üì∫ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –∫–∞–º–µ—Ä'}
                        </button>

                        {lastUpdated && (
                            <div className="mt-3 text-muted small">
                                –û–Ω–æ–≤–ª–µ–Ω–æ: {formatLastUpdated()}
                            </div>
                        )}
                    </div>

                    <div className="col-md-7">
                        {viewMode === 'monitor' ? (
                            <MonitorView
                                workplaces={getAllWorkplaces()}
                                onScreenshotClick={handleScreenshotClick}
                            />
                        ) : (
                            <>
                                <h1>–ö–∞–±—ñ–Ω–µ—Ç 329</h1>
                                <div className="row">
                                    {/* Left column (workplaces 10-18) */}
                                    <div className="col-md-6">
                                        {classroomData?.workplaces_2?.map(workplace => renderWorkplaceCard(workplace))}
                                    </div>

                                    {/* Right column (workplaces 9-1) */}
                                    <div className="col-md-6">
                                        {classroomData?.workplaces_1?.map(workplace => renderWorkplaceCard(workplace))}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    <div className="col-md-3">
                        <div className="card text-center border-primary">
                            <div className="card-body">
                                <h5 className="card-title">–ü–æ—Ç–æ—á–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏</h5>
                                <p className="card-text">
                                    –£—Ä–æ–∫–∏ –∑ {classroomData?.lesson_from} –¥–æ {classroomData?.lesson_to}
                                </p>
                                <p>
                                    {classroomData?.lesson_start && formatTime(classroomData.lesson_start)} -<br />
                                    {classroomData?.lesson_end && formatTime(classroomData.lesson_end)}
                                </p>
                            </div>
                        </div>

                        <div className="alert alert-primary mt-3">
                            <strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —É —Å–∏—Å—Ç–µ–º—ñ:</strong>{' '}
                            <span id="studentsCount">{classroomData?.unique_users_count || 0}</span>
                        </div>

                        {/* User names list */}
                        <div className="list-group mt-3">
                            {classroomData?.usernames?.map((username, idx) => (
                                <div key={idx} className="list-group-item list-group-item-action">
                                    {username}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('classroom-root'));
    root.render(<ClassroomApp />);
    {% endverbatim %}
</script>

{% endblock %}