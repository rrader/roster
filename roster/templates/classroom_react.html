{% extends "base.html" %}

{% block content %}

<div id="classroom-root"></div>

<!-- React and ReactDOM from CDN -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Babel Standalone for JSX transformation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
    .assign-btn {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)) !important;
        border: none !important;
        color: var(--btn-text-color) !important;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .assign-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 15px var(--shadow-color);
    }

    .delete-btn {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 0 4px;
        margin-left: 6px;
        transition: all 0.2s ease;
    }

    .delete-btn:hover {
        color: #ff4444;
        transform: scale(1.2);
    }

    .placement-row {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: var(--menu-bg);
        border: 2px solid var(--primary-color);
        border-radius: 10px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 30px var(--shadow-color);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-title {
        color: var(--primary-color);
        font-size: 1.3rem;
        font-weight: bold;
    }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 1;
    }

    .close-btn:hover {
        color: var(--primary-color);
    }

    .search-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        background-color: var(--input-bg) !important;
        border: 2px solid var(--primary-color) !important;
        color: var(--text-color) !important;
        border-radius: 5px;
    }

    .user-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 15px;
    }

    .user-item {
        padding: 10px;
        margin-bottom: 5px;
        background-color: var(--input-bg);
        border: 1px solid var(--primary-color);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .user-item:hover {
        background-color: var(--input-focus-bg);
        transform: translateX(5px);
    }

    .loading-text {
        color: var(--text-color);
        text-align: center;
        padding: 20px;
    }

    .error-text {
        color: #ff6b6b;
        padding: 10px;
        background-color: rgba(255, 0, 0, 0.1);
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .confirm-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
    }

    .confirm-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
    }

    .confirm-btn-yes {
        background: linear-gradient(45deg, #ff4444, #ff6b6b);
        color: white;
    }

    .confirm-btn-yes:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
    }

    .confirm-btn-no:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 10px var(--shadow-color);
    }

    /* Monitor View Styles */
    .monitor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        padding: 10px;
        background-color: #1a1a1a;
        border-radius: 8px;
    }

    .monitor-card {
        background-color: #000;
        border: 1px solid #333;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        aspect-ratio: 16/9;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .monitor-card:hover {
        border-color: var(--primary-color);
    }

    .monitor-screen {
        width: 100%;
        height: 100%;
        object-fit: contain;
        /* or cover, depending on preference */
        background-color: #000;
    }

    .monitor-screen.stale {
        filter: grayscale(100%) opacity(0.5);
    }

    .monitor-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 5px;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-dot {
        height: 8px;
        width: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .status-dot.active {
        background-color: #00ff00;
        box-shadow: 0 0 5px #00ff00;
    }

    .status-dot.stale {
        background-color: #ffff00;
    }

    .status-dot.missing {
        background-color: #ff0000;
    }

    .view-toggle-btn {
        margin-bottom: 10px;
        width: 100%;
    }

    /* Hover Info Styles */
    .monitor-hover-info {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        padding: 10px;
        text-align: center;
        pointer-events: none;
        z-index: 5;
    }

    .monitor-card:hover .monitor-hover-info {
        opacity: 1;
    }

    .hover-label {
        color: var(--primary-color);
        font-size: 0.7rem;
        text-transform: uppercase;
        margin-top: 5px;
    }

    .hover-value {
        font-size: 0.85rem;
        word-break: break-all;
    }

    /* Single Screenshot Detail Layout */
    .screenshot-details-layout {
        display: flex;
        gap: 20px;
        text-align: left;
    }

    .screenshot-main-view {
        flex: 3;
        display: flex;
        flex-direction: column;
    }

    .screenshot-sidebar {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #333;
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-width: 250px;
    }

    .sidebar-info-block {
        display: flex;
        flex-direction: column;
    }

    .sidebar-info-label {
        color: var(--primary-color);
        font-weight: bold;
        font-size: 0.75rem;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .sidebar-info-value {
        color: #fff;
        font-size: 0.95rem;
        word-break: break-all;
    }

    /* Search View Styles */
    .search-results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .search-card {
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
    }

    .search-card:hover {
        transform: translateY(-2px);
        border-color: var(--primary-color);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .search-card-img {
        width: 100%;
        aspect-ratio: 16/9;
        object-fit: cover;
        background: #000;
    }

    .search-card-info {
        padding: 10px;
        font-size: 0.85rem;
    }

    .search-card-user {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-card-meta {
        color: #aaa;
        display: flex;
        justify-content: space-between;
    }

    .search-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .search-input-group input {
        flex: 1;
        padding: 10px 15px;
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 5px;
        color: #fff;
        font-size: 1rem;
    }

    .search-input-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 5px var(--primary-color);
    }

    /* Calendar Styles */
    .search-calendar-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: #1a1a1a;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #333;
        margin-bottom: 20px;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .calendar-day-label {
        text-align: center;
        font-size: 0.75rem;
        color: #666;
        font-weight: bold;
        padding-bottom: 5px;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #222;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        position: relative;
    }

    .calendar-day:hover {
        background: #333;
        border-color: #444;
    }

    .calendar-day.selected {
        background: var(--primary-color);
        color: white;
        font-weight: bold;
    }

    .calendar-day.has-screenshots::after {
        content: '';
        position: absolute;
        bottom: 4px;
        width: 4px;
        height: 4px;
        background: var(--primary-color);
        border-radius: 50%;
    }

    .calendar-day.selected.has-screenshots::after {
        background: white;
    }

    .calendar-day.other-month {
        opacity: 0.2;
        pointer-events: none;
    }

    .search-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
    }

    .search-controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Timeline Styles */
    .timeline-container {
        position: relative;
        background: #111;
        border-top: 1px solid #333;
        padding: 10px 20px 20px 20px;
        overflow-x: auto;
        user-select: none;
        min-height: 150px;
        display: flex;
        flex-direction: column;
    }

    .timeline-track {
        position: relative;
        height: 80px;
        margin-top: 10px;
        /* Width will be set dynamically */
    }

    .timeline-item {
        position: absolute;
        top: 0;
        transform: translateX(-50%);
        cursor: pointer;
        transition: left 0.3s ease-out, transform 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 2;
    }

    .timeline-item:hover {
        z-index: 10;
        transform: translateX(-50%) scale(1.1);
    }

    .timeline-thumbnail {
        width: 100px;
        height: 56px;
        border: 1px solid #444;
        border-radius: 4px;
        object-fit: cover;
        background: #000;
        transition: all 0.2s;
    }

    .timeline-item.selected .timeline-thumbnail {
        border: 2px solid var(--primary-color);
        box-shadow: 0 0 10px var(--primary-color);
    }

    .timeline-dot {
        width: 10px;
        height: 10px;
        background: #666;
        border-radius: 50%;
        margin-top: 15px;
        transition: all 0.2s;
        border: 2px solid #111;
    }

    .timeline-item:hover .timeline-dot {
        background: #aaa;
    }

    .timeline-item.selected .timeline-dot {
        background: var(--primary-color);
        box-shadow: 0 0 5px var(--primary-color);
        width: 12px;
        height: 12px;
    }

    .timeline-label {
        font-size: 10px;
        color: #888;
        margin-top: 4px;
        white-space: nowrap;
    }

    .timeline-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
        margin-bottom: 5px;
    }

    .timeline-zoom-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px 12px;
        border-radius: 20px;
        border: 1px solid #333;
    }

    .zoom-btn {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 1rem;
        padding: 0 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .zoom-btn:hover {
        opacity: 1;
        color: var(--primary-color);
    }

    .zoom-btn:disabled {
        opacity: 0.2;
        cursor: not-allowed;
    }

    .zoom-slider {
        width: 100px;
        cursor: pointer;
        accent-color: var(--primary-color);
    }

    .timeline-axis {
        position: absolute;
        bottom: 25px;
        left: 0;
        right: 0;
        height: 2px;
        background: #333;
        z-index: 1;
    }
</style>


{% verbatim %}
<script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    function AssignmentModal({ isOpen, onClose, workplaceNumber, onAssign }) {
        const [searchTerm, setSearchTerm] = useState('');
        const [users, setUsers] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        useEffect(() => {
            if (isOpen && searchTerm.length >= 2) {
                const timer = setTimeout(async () => {
                    setLoading(true);
                    try {
                        const response = await fetch(`/search_users_ajax/?surname=${encodeURIComponent(searchTerm)}`);
                        const data = await response.json();
                        setUsers(data);
                        setError(null);
                    } catch (err) {
                        setError('Помилка пошуку користувачів');
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                }, 300);
                return () => clearTimeout(timer);
            } else {
                setUsers([]);
            }
        }, [searchTerm, isOpen]);

        const handleAssign = async (user) => {
            try {
                const workplaceId = `329-${workplaceNumber}`;
                const response = await fetch(`/api/classrooms/329/workplaces/${workplaceId}/assign/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: user.id }),
                });

                if (response.ok) {
                    onAssign();
                    onClose();
                    setSearchTerm('');
                } else {
                    const errorData = await response.json();
                    setError(errorData.error || 'Помилка призначення');
                }
            } catch (err) {
                setError('Помилка призначення користувача');
                console.error(err);
            }
        };

        if (!isOpen) return null;

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">Призначити на Workplace {workplaceNumber}</h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>

                    {error && <div className="error-text">{error}</div>}

                    <input
                        type="text"
                        className="search-input"
                        placeholder="Введіть прізвище..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        autoFocus
                    />

                    <div className="user-list">
                        {loading && <div className="loading-text">Пошук...</div>}
                        {!loading && searchTerm.length < 2 && (
                            <div className="loading-text">Введіть мінімум 2 символи</div>
                        )}
                        {!loading && users.length === 0 && searchTerm.length >= 2 && (
                            <div className="loading-text">Користувачів не знайдено</div>
                        )}
                        {!loading && users.map((user, idx) => (
                            <div
                                key={idx}
                                className="user-item"
                                onClick={() => handleAssign(user)}
                            >
                                {user.display}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    function ConfirmDeleteModal({ isOpen, onClose, placement, onConfirm }) {
        if (!isOpen || !placement) return null;

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">Підтвердження видалення</h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>

                    <p style={{ color: 'var(--text-color)', marginBottom: '15px' }}>
                        Ви впевнені, що хочете видалити призначення?
                    </p>
                    <p style={{ color: 'var(--primary-color)', fontWeight: 'bold' }}>
                        {placement.user.last_name} {placement.user.first_name}
                    </p>

                    <div className="confirm-buttons">
                        <button className="confirm-btn confirm-btn-no" onClick={onClose}>
                            Скасувати
                        </button>
                        <button className="confirm-btn confirm-btn-yes" onClick={onConfirm}>
                            Видалити
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    function Timeline({ history, selectedFilename, onSelect, workplaceNumber }) {
        const [zoom, setZoom] = useState(4.5); // Default to 90%
        const trackRef = React.useRef(null);

        // Parse dates and find range
        const items = useMemo(() => {
            const parsed = history.map(item => {
                const fname = item.filename;
                let d;
                if (item.created_at) {
                    d = new Date(item.created_at);
                } else {
                    const m = fname.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})?\.png$/);
                    if (m) {
                        d = new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]), parseInt(m[4]), parseInt(m[5]), m[6] ? parseInt(m[6]) : 0);
                    } else {
                        d = new Date();
                    }
                }
                return { ...item, date: d };
            });
            // Sort by date DESCENDING (newest first)
            return parsed.sort((a, b) => b.date - a.date);
        }, [history]);

        // Gap compression and positioning logic
        const decimatedItems = useMemo(() => {
            if (items.length === 0) return [];

            const MAX_VISUAL_GAP_MS = 10 * 60 * 1000; // Cap gaps at 10 minutes visually
            const baseWidth = 800 * Math.pow(2.5, zoom - 1);

            // We need a total "visual duration" to map pixels
            let visualDuration = 0;
            const processed = [];

            for (let i = 0; i < items.length; i++) {
                if (i > 0) {
                    const realGap = Math.abs(items[i].date - items[i - 1].date);
                    visualDuration += Math.min(realGap, MAX_VISUAL_GAP_MS);
                }
                processed.push({ ...items[i], visualOffset: visualDuration });
            }

            const totalVisualDuration = Math.max(1, visualDuration);
            const thumbWidth = 110;
            let lastThumbX = -1000;

            return processed.map(item => {
                const x = (item.visualOffset / totalVisualDuration) * baseWidth;
                const isSelected = item.filename === selectedFilename;

                let showThumb = false;
                if (isSelected || x - lastThumbX > thumbWidth || zoom >= 4.5) {
                    showThumb = true;
                    lastThumbX = x;
                }

                return { ...item, x, showThumb };
            });
        }, [items, zoom, selectedFilename]);

        const totalWidth = 800 * Math.pow(2.5, zoom - 1);

        // Auto-scroll to selected
        useEffect(() => {
            const selected = decimatedItems.find(i => i.filename === selectedFilename);
            if (selected && trackRef.current) {
                const container = trackRef.current.parentElement;
                const targetX = selected.x + 20;
                container.scrollTo({
                    left: targetX - container.clientWidth / 2,
                    behavior: 'smooth'
                });
            }
        }, [selectedFilename, zoom]);

        if (items.length === 0) return null;

        return (
            <div className="timeline-container">
                <div className="timeline-controls">
                    <div className="timeline-zoom-controls">
                        <button className="zoom-btn" onClick={() => setZoom(v => Math.max(1, v - 0.5))} disabled={zoom <= 1}>-</button>
                        <input
                            type="range"
                            min="1" max="5" step="0.1"
                            value={zoom}
                            onChange={(e) => setZoom(parseFloat(e.target.value))}
                            className="zoom-slider"
                        />
                        <button className="zoom-btn" onClick={() => setZoom(v => Math.min(5, v + 0.5))} disabled={zoom >= 5}>+</button>
                        <span style={{ fontSize: '10px', color: '#666', width: '30px' }}>{Math.round(zoom * 20)}%</span>
                    </div>
                </div>
                <div style={{ position: 'relative', overflowX: 'auto', flex: 1, paddingBottom: '10px', overscrollBehaviorX: 'none' }}>
                    <div className="timeline-track" style={{ width: `${totalWidth + 100}px` }} ref={trackRef}>
                        <div className="timeline-axis"></div>
                        {decimatedItems.map((item) => (
                            <div
                                key={item.filename}
                                className={`timeline-item ${item.filename === selectedFilename ? 'selected' : ''}`}
                                style={{ left: `${item.x + 20}px` }}
                                onClick={() => onSelect(item.filename)}
                                title={`${item.date.toLocaleString('uk-UA')} - ${item.user_name || 'No user'}`}
                            >
                                {item.showThumb ? (
                                    <img
                                        src={`/api/classrooms/329/workplaces/${workplaceNumber}/screenshots/${item.filename}/?thumb=1`}
                                        className="timeline-thumbnail"
                                        alt="thumb"
                                    />
                                ) : (
                                    <div className="timeline-dot"></div>
                                )}
                                <div className="timeline-label">
                                    {item.date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    function ScreenshotModal({ isOpen, onClose, workplaceId, classroomData, initialFilename }) {
        const [history, setHistory] = useState([]);
        const [selectedFilename, setSelectedFilename] = useState(null);
        const [loadingHistory, setLoadingHistory] = useState(false);

        // Reset state when opening for a new workplace
        useEffect(() => {
            if (isOpen && workplaceId) {
                setLoadingHistory(true);
                fetch(`/api/classrooms/329/workplaces/${workplaceId}/screenshots/`)
                    .then(res => res.json())
                    .then(data => {
                        // Data is now array of objects: {filename, created_at, user_name, os_username, reported_workplace}
                        // Or strings if API outdated (backward compat check)
                        const normalized = data.map(item => {
                            if (typeof item === 'string') return {
                                filename: item,
                                created_at: null,
                                user_name: null,
                                os_username: null,
                                reported_workplace: null
                            };
                            return item;
                        });
                        setHistory(normalized);
                        // Default to initialFilename if provided, else latest
                        if (initialFilename) {
                            setSelectedFilename(initialFilename);
                        } else if (normalized && normalized.length > 0) {
                            setSelectedFilename(normalized[0].filename);
                        }
                    })
                    .catch(err => console.error(err))
                    .finally(() => setLoadingHistory(false));
            } else {
                setHistory([]);
                setSelectedFilename(null);
            }
        }, [isOpen, workplaceId]);

        // Auto-update handling: if we are viewing the latest image, switch to the new latest if it arrives
        useEffect(() => {
            if (!isOpen || !workplaceId || !classroomData) return;
            const workplace = [...(classroomData.workplaces_1 || []), ...(classroomData.workplaces_2 || [])]
                .find(w => w.number === workplaceId);

            if (workplace && workplace.last_screenshot_filename) {
                // If we were viewing the previous "latest", or nothing selected, update to new latest
                // Logic: check if the new filename is present in history. If not, refresh history
                const latestInHistory = history.length > 0 ? history[0].filename : null;

                if (latestInHistory !== workplace.last_screenshot_filename) {
                    // Add new item to top of list
                    const newItem = {
                        filename: workplace.last_screenshot_filename,
                        created_at: workplace.last_screenshot_at,
                        user_name: workplace.last_user_name,
                        os_username: workplace.last_os_username,
                        reported_workplace: workplace.last_reported_workplace,
                        window_titles: workplace.last_window_titles || []
                    };

                    setHistory(prev => [newItem, ...prev]);
                    if (selectedFilename === latestInHistory) {
                        setSelectedFilename(workplace.last_screenshot_filename);
                    }
                }
            }
        }, [classroomData, isOpen, workplaceId]);


        if (!isOpen || !workplaceId || !classroomData) return null;

        // Find the workplace object from the fresh data
        const allWps = [...(classroomData.workplaces_1 || []), ...(classroomData.workplaces_2 || [])];
        if (classroomData.teacher_workplace) allWps.push(classroomData.teacher_workplace);

        const workplace = allWps.find(w => w.number === workplaceId);

        if (!workplace) return null;

        // Determine which file to show
        const filenameToShow = selectedFilename || workplace.last_screenshot_filename;

        // Find metadata for selected file
        const selectedMeta = history.find(h => h.filename === filenameToShow) || {};
        const userName = selectedMeta.user_name;

        // If still no filename (never uploaded), show NO SIGNAL
        if (!filenameToShow) {
            return (
                <div className="modal show" onClick={onClose}>
                    <div className="modal-content" style={{ maxWidth: '900px', width: '95%' }} onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3 className="modal-title">Скріншот Workplace {workplace.number}</h3>
                            <button className="close-btn" onClick={onClose}>&times;</button>
                        </div>
                        <div className="text-center p-5 font-weight-bold text-danger">NO SIGNAL (No Data)</div>
                    </div>
                </div>
            );
        }

        // Parse timestamp from filename: YYYYMMDD_HHMMSS.png
        // If it matches that pattern, use it. Otherwise fall back to last_screenshot_at if it's the latest file.
        let timestamp;
        if (selectedMeta.created_at) {
            timestamp = new Date(selectedMeta.created_at);
        } else {
            const match = filenameToShow.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})?\.png$/);
            if (match) {
                timestamp = new Date(
                    parseInt(match[1]),
                    parseInt(match[2]) - 1,
                    parseInt(match[3]),
                    parseInt(match[4]),
                    parseInt(match[5]),
                    match[6] ? parseInt(match[6]) : 0
                );
            } else if (filenameToShow === workplace.last_screenshot_filename) {
                timestamp = new Date(workplace.last_screenshot_at);
            } else {
                timestamp = new Date(); // Fallback
            }
        }


        // Calculate status for modal (same logic as MonitorView)
        // Only apply "Lost" logic if we are viewing the LATEST file
        const isLatest = filenameToShow === workplace.last_screenshot_filename;
        const age = new Date() - timestamp;
        const isLost = isLatest && (age > 12 * 60 * 60 * 1000); // > 12 hours
        const isStale = age > 15 * 60 * 1000;     // > 15 mins

        let statusClass = 'active';
        if (isLost) statusClass = 'missing';
        else if (isStale) statusClass = 'stale';

        const displayImage = true; // Always display image in modal, even if signal is lost
        const imageUrl = `/api/classrooms/329/workplaces/${workplace.number}/screenshots/${filenameToShow}/`;

        // Helper to scroll horizontal list

        // Helper to Format Time
        const formatTimeShort = (date) => {
            return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
        };

        // Helper to calculate "time ago"
        const getTimeAgo = (date) => {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + " years ago";
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + " months ago";
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + " days ago";
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + " hours ago";
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + " mins ago";
            return Math.floor(seconds) + " seconds ago";
        };

        const timeAgo = getTimeAgo(timestamp);

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" style={{ maxWidth: '900px', width: '95%' }} onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">
                            <span className={`status-dot ${statusClass}`} style={{ marginRight: '10px' }}></span>
                            Скріншот {workplace.number}
                        </h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>
                    <div className="screenshot-details-layout">
                        <div className="screenshot-main-view">
                            <div className="text-center mb-2 text-muted">
                                {timestamp.toLocaleString('uk-UA')} ({timeAgo})
                            </div>
                            <div style={{ textAlign: 'center', backgroundColor: '#000', minHeight: '300px', display: 'flex', flexDirection: 'column' }}>
                                <div style={{ flex: 1, display: 'flex', alignItems: 'center', justifyContent: 'center', overflow: 'hidden', padding: '10px' }}>
                                    {displayImage ? (
                                        <img
                                            src={imageUrl}
                                            alt={`Screenshot ${workplace.number}`}
                                            style={{ maxWidth: '100%', maxHeight: '60vh', border: '1px solid #333' }}
                                        />
                                    ) : (
                                        <div style={{
                                            color: '#ff0000',
                                            fontWeight: 'bold',
                                            fontSize: '1.5rem',
                                        }}>
                                            NO SIGNAL
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="screenshot-sidebar">
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">Workplace</span>
                                <span className="sidebar-info-value">{selectedMeta.reported_workplace || (isLatest ? workplace.last_reported_workplace : null) || workplace.number}</span>
                            </div>
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">OS User</span>
                                <span className="sidebar-info-value">{selectedMeta.os_username || (isLatest ? workplace.last_os_username : null) || 'Unknown'}</span>
                            </div>
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">Student</span>
                                <span className="sidebar-info-value">{userName || (isLatest && workplace.placements && workplace.placements.length > 0 ? `${workplace.placements[0].user.last_name} ${workplace.placements[0].user.first_name}` : 'Unknown')}</span>
                            </div>
                            <div className="sidebar-info-block">
                                <span className="sidebar-info-label">Captured</span>
                                <span className="sidebar-info-value">{timestamp.toLocaleString('uk-UA')}</span>
                            </div>
                            <div className="sidebar-info-block" style={{ flex: 1, minHeight: 0 }}>
                                <span className="sidebar-info-label">Open Windows</span>
                                <div style={{
                                    maxHeight: '180px',
                                    overflowY: 'auto',
                                    background: 'rgba(0,0,0,0.2)',
                                    borderRadius: '4px',
                                    padding: '5px',
                                    marginTop: '5px',
                                    border: '1px solid #333'
                                }}>
                                    {(() => {
                                        // Priority: 1. selectedMeta.window_titles, 2. If it is the latest, workplace.last_window_titles
                                        let titles = selectedMeta.window_titles;
                                        if ((titles === undefined || titles === null) && isLatest) {
                                            titles = workplace.last_window_titles;
                                        }

                                        // Final normalization: if we have a list/string that looks like [A, B, C], split it
                                        let finalTitles = [];
                                        if (Array.isArray(titles)) {
                                            titles.forEach(t => {
                                                if (typeof t === 'string' && t.startsWith('[') && t.endsWith(']')) {
                                                    const inner = t.substring(1, t.length - 1);
                                                    const splitted = inner.split(',').map(s => s.trim().replace(/^["']|["']$/g, ''));
                                                    finalTitles.push(...splitted);
                                                } else {
                                                    finalTitles.push(t);
                                                }
                                            });
                                        } else if (typeof titles === 'string' && titles.startsWith('[') && titles.endsWith(']')) {
                                            const inner = titles.substring(1, titles.length - 1);
                                            finalTitles = inner.split(',').map(s => s.trim().replace(/^["']|["']$/g, ''));
                                        }

                                        if (finalTitles.length > 0) {
                                            return finalTitles.map((title, idx) => (
                                                <div key={idx} style={{
                                                    fontSize: '0.8rem',
                                                    color: '#ccc',
                                                    padding: '3px 0',
                                                    borderBottom: idx === finalTitles.length - 1 ? 'none' : '1px solid #222',
                                                    whiteSpace: 'nowrap',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis'
                                                }} title={title}>
                                                    • {title}
                                                </div>
                                            ));
                                        }
                                        return <div style={{ fontSize: '0.8rem', color: '#666', fontStyle: 'italic' }}>No windows detected</div>;
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>

                    <Timeline
                        history={history}
                        selectedFilename={filenameToShow}
                        onSelect={setSelectedFilename}
                        workplaceNumber={workplace.number}
                    />
                </div>
            </div>
        );
    }

    function MonitorView({ workplaces, onScreenshotClick }) {
        // Sort workplaces by number to ensure 1-18 order
        const sortedWorkplaces = [...workplaces].sort((a, b) => a.number - b.number);

        // Fill in missing workplaces if needed (assuming 1-18 range)
        const allWorkplaces = [];
        const existingMap = new Map(sortedWorkplaces.map(w => [w.number, w]));

        for (let i = 1; i <= 19; i++) {
            if (existingMap.has(i)) {
                allWorkplaces.push(existingMap.get(i));
            } else {
                allWorkplaces.push({ number: i, last_screenshot_filename: null });
            }
        }

        return (
            <div className="monitor-container">
                <h3 className="text-center mb-3">Моніторинг екранів</h3>
                <div className="monitor-grid">
                    {allWorkplaces.map(wp => {
                        const hasScreenshot = !!wp.last_screenshot_filename;
                        const lastUpdate = wp.last_screenshot_at ? new Date(wp.last_screenshot_at) : null;

                        let statusClass = 'missing'; // Default to missing (Red)
                        let isLost = true;
                        let isStale = false;

                        if (hasScreenshot && lastUpdate) {
                            const age = new Date() - lastUpdate;
                            isLost = age > 12 * 60 * 60 * 1000; // > 12 hours
                            isStale = age > 15 * 60 * 1000;     // > 15 mins

                            if (isLost) {
                                statusClass = 'missing';
                            } else if (isStale) {
                                statusClass = 'stale';
                            } else {
                                statusClass = 'active';
                            }
                        }

                        // Determine if we show the image
                        // We show image only if we have one AND it's not "lost" (>12h)
                        const showImage = hasScreenshot && !isLost;

                        const imageUrl = showImage
                            ? `/api/classrooms/329/workplaces/${wp.number}/screenshots/${wp.last_screenshot_filename}/?thumb=1&t=${lastUpdate ? lastUpdate.getTime() : Date.now()}`
                            : null;

                        return (
                            <div
                                key={wp.number}
                                className="monitor-card"
                                onClick={() => hasScreenshot && onScreenshotClick(wp)}
                                title={hasScreenshot ? `Updated: ${lastUpdate.toLocaleTimeString('uk-UA')}` : 'No Signal'}
                            >
                                {showImage ? (
                                    <img
                                        src={imageUrl}
                                        className={`monitor-screen ${isStale ? 'stale' : ''}`}
                                        alt={`WP ${wp.number}`}
                                    />
                                ) : (
                                    <div className="monitor-screen" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', color: statusClass === 'missing' ? '#ff0000' : '#333', fontWeight: 'bold' }}>
                                        NO SIGNAL
                                    </div>
                                )}
                                {hasScreenshot && (
                                    <div className="monitor-hover-info">
                                        <div className="hover-label">Workspace</div>
                                        <div className="hover-value">{wp.last_reported_workplace || wp.number}</div>
                                        <div className="hover-label">OS User</div>
                                        <div className="hover-value">{wp.last_os_username || 'Unknown'}</div>
                                    </div>
                                )}
                                <div className="monitor-overlay">
                                    <span>
                                        <span className={`status-dot ${statusClass}`}></span>
                                        {wp.number === 19 ? 'TEACHER (W-19)' : `W-${wp.number}`}
                                    </span>
                                    {lastUpdate && <span>{lastUpdate.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })}</span>}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    }

    function Calendar({ selectedDate, onDateSelect, availableDates }) {
        const [viewDate, setViewDate] = useState(new Date());

        const daysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const startDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();

        const days = [];
        const totalDays = daysInMonth(year, month);
        const startDay = (startDayOfMonth(year, month) + 6) % 7; // Adjust to Monday start

        // Month name in Ukrainian
        const monthNames = ["Січень", "Лютий", "Березень", "Квітень", "Травень", "Червень",
            "Липень", "Серпень", "Вересень", "Жовтень", "Листопад", "Грудень"];

        // Fill previous month padding
        for (let i = 0; i < startDay; i++) {
            days.push({ day: '', otherMonth: true });
        }

        // Current month days
        for (let i = 1; i <= totalDays; i++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            days.push({
                day: i,
                dateStr,
                selected: selectedDate === dateStr,
                hasScreenshots: availableDates.includes(dateStr)
            });
        }

        const nextMonth = () => setViewDate(new Date(year, month + 1));
        const prevMonth = () => setViewDate(new Date(year, month - 1));

        return (
            <div className="search-calendar-container">
                <div className="calendar-header">
                    <button className="btn btn-sm btn-outline-secondary" onClick={prevMonth}>&lt;</button>
                    <strong>{monthNames[month]} {year}</strong>
                    <button className="btn btn-sm btn-outline-secondary" onClick={nextMonth}>&gt;</button>
                </div>
                <div className="calendar-grid">
                    {['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Нд'].map(d => (
                        <div key={d} className="calendar-day-label">{d}</div>
                    ))}
                    {days.map((d, i) => (
                        <div
                            key={i}
                            className={`calendar-day ${d.otherMonth ? 'other-month' : ''} ${d.selected ? 'selected' : ''} ${d.hasScreenshots ? 'has-screenshots' : ''}`}
                            onClick={() => d.day && onDateSelect(d.dateStr)}
                        >
                            {d.day}
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    function HistorySearchView({ onScreenshotClick }) {
        const [query, setQuery] = useState('');
        const [selectedDate, setSelectedDate] = useState(null);
        const [results, setResults] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showDeleted, setShowDeleted] = useState(false);
        const [availableDates, setAvailableDates] = useState([]);

        // Load available dates on mount
        useEffect(() => {
            fetch('/api/classrooms/329/screenshots/dates/')
                .then(res => res.json())
                .then(data => setAvailableDates(data))
                .catch(err => console.error('Error fetching dates:', err));
        }, []);

        const handleSearch = useCallback(async (q = query, d = selectedDate, sd = showDeleted) => {
            if (!q && !d && !sd) return;
            setLoading(true);
            try {
                const params = new URLSearchParams();
                if (q) params.append('q', q);
                if (d) params.append('date', d);
                if (sd) params.append('show_deleted', 'on');

                const response = await fetch(`/api/classrooms/329/screenshots/search/?${params}`);
                const data = await response.json();
                setResults(data);
            } catch (err) {
                console.error('Search error:', err);
            } finally {
                setLoading(false);
            }
        }, [query, selectedDate, showDeleted]);

        // Auto-search when date or showDeleted is changed
        useEffect(() => {
            if (selectedDate || showDeleted) handleSearch(query, selectedDate, showDeleted);
        }, [selectedDate, showDeleted]);

        const handleKeyPress = (e) => {
            if (e.key === 'Enter') handleSearch();
        };

        return (
            <div className="search-view-container">
                <h3 className="text-center mb-4">Пошук скріншотів по історії</h3>

                <div className="search-layout">
                    <div className="search-controls">
                        <div className="search-input-group" style={{ marginBottom: 0 }}>
                            <input
                                type="text"
                                placeholder="OS user / Студент..."
                                value={query}
                                onChange={(e) => setQuery(e.target.value)}
                                onKeyPress={handleKeyPress}
                                autoFocus
                            />
                        </div>
                        <Calendar
                            selectedDate={selectedDate}
                            onDateSelect={(d) => setSelectedDate(d === selectedDate ? null : d)}
                            availableDates={availableDates}
                        />
                        <div className="form-check mt-3 mb-3">
                            <input
                                type="checkbox"
                                id="showDeletedSearch"
                                className="form-check-input"
                                checked={showDeleted}
                                onChange={(e) => setShowDeleted(e.target.checked)}
                            />
                            <label htmlFor="showDeletedSearch" className="form-check-label">
                                Показати видалені скріншоти
                            </label>
                        </div>
                        <button className="btn btn-primary w-100" onClick={() => handleSearch()} disabled={loading}>
                            {loading ? 'Пошук...' : 'Знайти'}
                        </button>
                        {selectedDate && (
                            <button className="btn btn-outline-secondary w-100 mt-2" onClick={() => {
                                setSelectedDate(null);
                                setResults([]);
                            }}>
                                Скинути фільтри
                            </button>
                        )}
                    </div>

                    <div className="search-results-content">
                        {results.length > 0 ? (
                            <div className="search-results-grid">
                                {results.map((item, idx) => (
                                    <div
                                        key={idx}
                                        className="search-card"
                                        onClick={() => !item.image_deleted && onScreenshotClick({
                                            number: item.workplace_number,
                                            last_screenshot_filename: item.filename
                                        }, item.filename)}
                                        style={{ opacity: item.image_deleted ? 0.7 : 1, cursor: item.image_deleted ? 'default' : 'pointer' }}
                                    >
                                        <div style={{ position: 'relative' }}>
                                            <img
                                                src={item.image_deleted ? 'https://placehold.co/400x300?text=Image+Removed' : `/api/classrooms/329/workplaces/${item.workplace_number}/screenshots/${item.filename}/?thumb=1`}
                                                className="search-card-img"
                                                alt="Screenshot"
                                            />
                                            {item.image_deleted && (
                                                <div style={{
                                                    position: 'absolute',
                                                    top: '10px',
                                                    right: '10px',
                                                    background: '#dc3545',
                                                    color: 'white',
                                                    padding: '2px 8px',
                                                    borderRadius: '4px',
                                                    fontSize: '11px',
                                                    fontWeight: 'bold'
                                                }}>
                                                    ФАЙЛ ВИДАЛЕНО
                                                </div>
                                            )}
                                        </div>
                                        <div className="search-card-info">
                                            <div className="search-card-user">
                                                {item.user_name || 'Anonymous'} ({item.os_username || 'unknown'})
                                            </div>
                                            <div className="search-card-meta">
                                                <span>W-{item.workplace_number}</span>
                                                <span>{new Date(item.created_at).toLocaleString('uk-UA')}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : !loading && (query || selectedDate) ? (
                            <div className="text-center text-muted mt-5">Нічого не знайдено</div>
                        ) : (
                            <div className="text-center text-muted mt-5">Виберіть дату або введіть ім'я для пошуку</div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    function ClassroomApp() {
        const [classroomData, setClassroomData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [lastUpdated, setLastUpdated] = useState(null);

        // Filter state
        const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
        const [lesson, setLesson] = useState(null); // Will be fetched from server
        const [singles, setSingles] = useState(false);
        const [autoUpdate, setAutoUpdate] = useState(true); // Auto-update lesson
        const [screenshotsEnabled, setScreenshotsEnabled] = useState(true); // Screenshots toggle
        const [screenshotInterval, setScreenshotInterval] = useState(60); // Screenshot interval (seconds)
        const [viewMode, setViewMode] = useState('list'); // 'list' or 'monitor'

        // Modal state
        const [modalOpen, setModalOpen] = useState(false);
        const [selectedWorkplace, setSelectedWorkplace] = useState(null);
        const [deleteModalOpen, setDeleteModalOpen] = useState(false);
        const [placementToDelete, setPlacementToDelete] = useState(null);
        const [screenshotModalOpen, setScreenshotModalOpen] = useState(false);
        const [screenshotWorkplaceId, setScreenshotWorkplaceId] = useState(null);
        const [initialScreenshotFilename, setInitialScreenshotFilename] = useState(null);

        const REFRESH_INTERVAL = 5000; // 5 seconds

        // Get current lesson from server on initial load
        useEffect(() => {
            const getCurrentLesson = async () => {
                if (!autoUpdate) {
                    // If auto-update is disabled, use fallback
                    if (!lesson) setLesson('1');
                    return;
                }

                try {
                    const response = await fetch('/api/classrooms/329/');
                    if (response.ok) {
                        const data = await response.json();
                        let lessonNum = data.lesson; // 1-based

                        // Initial load is usually paired mode (singles default false)
                        if (!singles && lessonNum % 2 === 0) {
                            lessonNum = lessonNum - 1;
                        }

                        const lessonIndex = Math.max(1, lessonNum);
                        setLesson(lessonIndex.toString());
                    } else {
                        setLesson('1'); // Fallback
                    }
                } catch (err) {
                    console.error('Error fetching current lesson:', err);
                    setLesson('1'); // Fallback
                }
            };
            getCurrentLesson();
        }, [autoUpdate]);

        // Adjust lesson when switching between paired/single mode
        useEffect(() => {
            if (!lesson) return;

            const lessonNum = parseInt(lesson);
            if (!singles && lessonNum % 2 === 0) {
                // Switching to paired mode and current lesson is even (2,4,6,8)
                // Round down to the paired lesson (1,3,5,7)
                setLesson((lessonNum - 1).toString());
            }
        }, [singles]);

        const fetchClassroomData = useCallback(async () => {
            if (!lesson) return; // Don't fetch until lesson is initialized

            try {
                const params = new URLSearchParams({
                    date: date,
                    lesson: lesson,
                    singles: singles ? 'on' : 'off'
                });

                const response = await fetch(`/api/classrooms/329/?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                setClassroomData(data);
                setLastUpdated(new Date());
                setError(null);

                // Auto-update lesson if enabled and lesson has changed
                if (autoUpdate && data.lesson !== undefined) {
                    let lessonNum = data.lesson; // 1-based

                    // Sort of redundant now as backend does logic, but good for safety
                    // If in paired mode (default), pairs start at odd numbers (1, 3, 5...)
                    // So if we get an even number (2, 4...), round down to the pair start
                    if (!singles && lessonNum % 2 === 0) {
                        lessonNum = lessonNum - 1;
                    }

                    // Use 1-based index directly
                    if (lessonNum.toString() !== lesson) {
                        setLesson(lessonNum.toString());
                    }
                }

                // Update screenshots state from server 
                if (data.screenshots_enabled !== undefined) {
                    setScreenshotsEnabled(data.screenshots_enabled);
                }
                if (data.screenshot_interval !== undefined) {
                    setScreenshotInterval(data.screenshot_interval);
                }
            } catch (err) {
                setError(err.message);
                console.error('Error fetching classroom data:', err);
            } finally {
                setLoading(false);
            }
        }, [date, lesson, singles, autoUpdate]);

        // Initial fetch and auto-refresh
        useEffect(() => {
            fetchClassroomData();
            const interval = setInterval(fetchClassroomData, REFRESH_INTERVAL);
            return () => clearInterval(interval);
        }, [fetchClassroomData]);

        const handleScreenshotClick = (workplace, initialFilename = null) => {
            setScreenshotWorkplaceId(workplace.number);
            setInitialScreenshotFilename(initialFilename);
            setScreenshotModalOpen(true);
        };

        const handleCloseScreenshotModal = () => {
            setScreenshotModalOpen(false);
            setScreenshotWorkplaceId(null);
            setInitialScreenshotFilename(null);
        };

        const handleViewModeToggle = () => {
            setViewMode(prev => prev === 'list' ? 'monitor' : 'list');
        };

        const getAllWorkplaces = () => {
            if (!classroomData) return [];
            const list = [
                ...(classroomData.workplaces_1 || []),
                ...(classroomData.workplaces_2 || [])
            ];
            if (classroomData.teacher_workplace) {
                list.push(classroomData.teacher_workplace);
            }
            return list;
        };

        const formatTime = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
        };

        const formatLastUpdated = () => {
            if (!lastUpdated) return '';
            return lastUpdated.toLocaleTimeString('uk-UA', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        };

        const handleOpenModal = (workplaceNumber) => {
            setSelectedWorkplace(workplaceNumber);
            setModalOpen(true);
        };

        const handleCloseModal = () => {
            setModalOpen(false);
            setSelectedWorkplace(null);
        };

        const handleAssignSuccess = () => {
            fetchClassroomData();
        };

        const handleDeleteClick = (placement) => {
            setPlacementToDelete(placement);
            setDeleteModalOpen(true);
        };

        const handleDeleteConfirm = async () => {
            if (!placementToDelete) return;

            try {
                const response = await fetch(
                    `/api/classrooms/329/workplaces/${placementToDelete.workplace_id}/?placement_id=${placementToDelete.id}`,
                    { method: 'DELETE' }
                );

                if (response.ok) {
                    fetchClassroomData();
                    setDeleteModalOpen(false);
                    setPlacementToDelete(null);
                } else {
                    const errorData = await response.json();
                    alert('Помилка видалення: ' + (errorData.error || 'Невідома помилка'));
                }
            } catch (err) {
                alert('Помилка видалення: ' + err.message);
                console.error(err);
            }
        };

        const handleDeleteCancel = () => {
            setDeleteModalOpen(false);
            setPlacementToDelete(null);
        };

        const handleScreenshotsToggle = async (enabled) => {
            try {
                const response = await fetch('/api/classrooms/329/screenshots/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ screenshots_enabled: enabled }),
                });

                if (response.ok) {
                    setScreenshotsEnabled(enabled);
                } else {
                    console.error('Failed to update screenshots setting');
                    setScreenshotsEnabled(!enabled);
                }
            } catch (err) {
                console.error('Error updating screenshots setting:', err);
                setScreenshotsEnabled(!enabled);
            }
        };

        const handleScreenshotIntervalChange = async (interval) => {
            try {
                const response = await fetch('/api/classrooms/329/screenshots/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ screenshot_interval: parseInt(interval) }),
                });

                if (response.ok) {
                    setScreenshotInterval(parseInt(interval));
                } else {
                    console.error('Failed to update screenshot interval');
                }
            } catch (err) {
                console.error('Error updating screenshot interval:', err);
            }
        };

        // Helper for rendering workplace card (to deduplicate code)
        const renderWorkplaceCard = (workplace) => (
            <div key={workplace.number} className="card text-center border-success mt-2">
                <div className="card-body pt-1 pb-1">
                    <h5 className="card-title" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '0' }}>
                        <span>{workplace.number === 19 ? 'Teacher (W-19)' : `Workplace ${workplace.number}`}</span>
                        <div>
                            {workplace.last_screenshot_filename && (
                                <button
                                    className="assign-btn"
                                    onClick={() => handleScreenshotClick(workplace)}
                                    title={`Скріншот: ${formatTime(workplace.last_screenshot_at)}`}
                                    style={{ padding: '2px 6px', fontSize: '12px', marginLeft: '4px', background: 'linear-gradient(45deg, #17a2b8, #138496)' }}
                                >
                                    📷
                                </button>
                            )}
                            <button
                                className="assign-btn"
                                onClick={() => handleOpenModal(workplace.number)}
                                title="Додати студента"
                                style={{ padding: '2px 6px', fontSize: '12px', marginLeft: '4px' }}
                            >
                                ➕
                            </button>
                        </div>
                    </h5>
                    {workplace.placements.map(placement => (
                        <div key={placement.id} className="placement-row">
                            <span>
                                {placement.user.last_name} {placement.user.first_name}{' '}
                                <span className="text-success">
                                    {formatTime(placement.created_at)}
                                </span>
                            </span>
                            <button
                                className="delete-btn"
                                onClick={() => handleDeleteClick(placement)}
                                title="Видалити призначення"
                            >
                                ❌
                            </button>
                            <br />
                        </div>
                    ))}
                </div>
            </div>
        );

        return (
            <React.Fragment>
                <div className="container mt-3">
                    <AssignmentModal
                        isOpen={modalOpen}
                        onClose={handleCloseModal}
                        workplaceNumber={selectedWorkplace}
                        onAssign={handleAssignSuccess}
                    />

                    <ConfirmDeleteModal
                        isOpen={deleteModalOpen}
                        onClose={handleDeleteCancel}
                        placement={placementToDelete}
                        onConfirm={handleDeleteConfirm}
                    />

                    <ScreenshotModal
                        isOpen={screenshotModalOpen}
                        onClose={handleCloseScreenshotModal}
                        workplaceId={screenshotWorkplaceId}
                        classroomData={classroomData}
                        initialFilename={initialScreenshotFilename}
                    />

                    <div className="row mb-4 g-3">
                        <div className="col-md-2">
                            <label htmlFor="dateFilter" className="form-label">Обрати дату:</label>
                            <input
                                type="date"
                                id="dateFilter"
                                className="form-control"
                                value={date}
                                onChange={(e) => setDate(e.target.value)}
                            />

                            <label htmlFor="lessonFilter" className="form-label mt-2">Урок:</label>
                            <select
                                id="lessonFilter"
                                className="form-select"
                                value={lesson}
                                onChange={(e) => setLesson(e.target.value)}
                            >
                                {singles
                                    ? [1, 2, 3, 4, 5, 6, 7, 8].map(num => (
                                        <option key={num} value={num}>{num} урок</option>
                                    ))
                                    : [1, 3, 5, 7].map(num => (
                                        <option key={num} value={num}>{num}-{num + 1} уроки</option>
                                    ))
                                }
                            </select>

                            <div className="form-check mt-2">
                                <input
                                    type="checkbox"
                                    id="pairFilter"
                                    className="form-check-input"
                                    checked={singles}
                                    onChange={(e) => setSingles(e.target.checked)}
                                />
                                <label htmlFor="pairFilter" className="form-check-label">
                                    Одиночні уроки
                                </label>
                            </div>

                            <div className="form-check mt-2">
                                <input
                                    type="checkbox"
                                    id="autoUpdateFilter"
                                    className="form-check-input"
                                    checked={!autoUpdate}
                                    onChange={(e) => setAutoUpdate(!e.target.checked)}
                                />
                                <label htmlFor="autoUpdateFilter" className="form-check-label">
                                    Не оновлювати
                                </label>
                            </div>

                            <div className="form-check mt-2">
                                <input
                                    type="checkbox"
                                    id="screenshotsFilter"
                                    className="form-check-input"
                                    checked={screenshotsEnabled}
                                    onChange={(e) => handleScreenshotsToggle(e.target.checked)}
                                />
                                <label htmlFor="screenshotsFilter" className="form-check-label">
                                    Скріншоти увімкнені
                                </label>
                            </div>

                            <div className="mt-2">
                                <label htmlFor="intervalFilter" className="form-label mb-1" style={{ fontSize: '0.85rem' }}>Частота скріншотів:</label>
                                <select
                                    id="intervalFilter"
                                    className="form-select form-select-sm"
                                    value={screenshotInterval}
                                    onChange={(e) => handleScreenshotIntervalChange(e.target.value)}
                                >
                                    <option value="10">10 секунд</option>
                                    <option value="30">30 секунд</option>
                                    <option value="60">1 хвилина</option>
                                    <option value="600">10 хвилин</option>
                                </select>
                            </div>

                            <hr />

                            <button
                                className={`btn ${viewMode === 'monitor' ? 'btn-primary' : 'btn-outline-primary'} view-toggle-btn`}
                                onClick={() => setViewMode(viewMode === 'monitor' ? 'list' : 'monitor')}
                            >
                                {viewMode === 'monitor' ? '📋 Список' : '📺 Моніторинг екранів'}
                            </button>

                            <button
                                className={`btn ${viewMode === 'search' ? 'btn-primary' : 'btn-outline-primary'} view-toggle-btn`}
                                onClick={() => setViewMode(viewMode === 'search' ? 'list' : 'search')}
                            >
                                {viewMode === 'search' ? '📋 Список' : '🔍 Пошук скріншотів'}
                            </button>

                            {lastUpdated && (
                                <div className="mt-3 text-muted small">
                                    Оновлено: {formatLastUpdated()}
                                </div>
                            )}
                        </div>

                        <div className="col-md-7">
                            {viewMode === 'monitor' ? (
                                <MonitorView
                                    workplaces={getAllWorkplaces()}
                                    onScreenshotClick={handleScreenshotClick}
                                />
                            ) : viewMode === 'search' ? (
                                <HistorySearchView
                                    onScreenshotClick={(item) => handleScreenshotClick({ number: item.workplace_number }, item.filename)}
                                />
                            ) : (
                                <React.Fragment>
                                    <h1>Кабінет 329</h1>
                                    {classroomData?.teacher_workplace && (
                                        <div className="row mb-3">
                                            <div className="col-md-12">
                                                {renderWorkplaceCard(classroomData.teacher_workplace)}
                                            </div>
                                        </div>
                                    )}
                                    <div className="row">
                                        <div className="col-md-6">
                                            {classroomData?.workplaces_2?.map(workplace => renderWorkplaceCard(workplace))}
                                        </div>
                                        <div className="col-md-6">
                                            {classroomData?.workplaces_1?.map(workplace => renderWorkplaceCard(workplace))}
                                        </div>
                                    </div>
                                </React.Fragment>
                            )}
                        </div>

                        <div className="col-md-3">
                            <div className="card text-center border-primary">
                                <div className="card-body">
                                    <h5 className="card-title">Поточні фільтри</h5>
                                    <p className="card-text">
                                        Уроки з {classroomData?.lesson_from} до {classroomData?.lesson_to}
                                    </p>
                                    <p>
                                        {classroomData?.lesson_start && formatTime(classroomData.lesson_start)} -<br />
                                        {classroomData?.lesson_end && formatTime(classroomData.lesson_end)}
                                    </p>
                                </div>
                            </div>

                            <div className="alert alert-primary mt-3">
                                <strong>Користувачі у системі:</strong>{' '}
                                <span id="studentsCount">{classroomData?.unique_users_count || 0}</span>
                            </div>

                            <div className="list-group mt-3">
                                {classroomData?.usernames?.map((username, idx) => (
                                    <div key={idx} className="list-group-item list-group-item-action">
                                        {username}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            </React.Fragment>
        );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('classroom-root'));
    root.render(<ClassroomApp />);
    {% endverbatim %}
</script>

{% endblock %}