{% extends "base.html" %}

{% block content %}

<div id="classroom-root"></div>

<!-- React and ReactDOM from CDN -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Babel Standalone for JSX transformation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
    .assign-btn {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)) !important;
        border: none !important;
        color: var(--btn-text-color) !important;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .assign-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 15px var(--shadow-color);
    }

    .delete-btn {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 0 4px;
        margin-left: 6px;
        transition: all 0.2s ease;
    }

    .delete-btn:hover {
        color: #ff4444;
        transform: scale(1.2);
    }

    .placement-row {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: var(--menu-bg);
        border: 2px solid var(--primary-color);
        border-radius: 10px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 30px var(--shadow-color);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-title {
        color: var(--primary-color);
        font-size: 1.3rem;
        font-weight: bold;
    }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 1;
    }

    .close-btn:hover {
        color: var(--primary-color);
    }

    .search-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        background-color: var(--input-bg) !important;
        border: 2px solid var(--primary-color) !important;
        color: var(--text-color) !important;
        border-radius: 5px;
    }

    .user-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 15px;
    }

    .user-item {
        padding: 10px;
        margin-bottom: 5px;
        background-color: var(--input-bg);
        border: 1px solid var(--primary-color);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .user-item:hover {
        background-color: var(--input-focus-bg);
        transform: translateX(5px);
    }

    .loading-text {
        color: var(--text-color);
        text-align: center;
        padding: 20px;
    }

    .error-text {
        color: #ff6b6b;
        padding: 10px;
        background-color: rgba(255, 0, 0, 0.1);
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .confirm-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
    }

    .confirm-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
    }

    .confirm-btn-yes {
        background: linear-gradient(45deg, #ff4444, #ff6b6b);
        color: white;
    }

    .confirm-btn-yes:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
    }

    .confirm-btn-no {
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        color: var(--btn-text-color);
    }

    .confirm-btn-no:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 10px var(--shadow-color);
    }
</style>

{% verbatim %}
<script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    function AssignmentModal({ isOpen, onClose, workplaceNumber, onAssign }) {
        const [searchTerm, setSearchTerm] = useState('');
        const [users, setUsers] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        useEffect(() => {
            if (isOpen && searchTerm.length >= 2) {
                const timer = setTimeout(async () => {
                    setLoading(true);
                    try {
                        const response = await fetch(`/search_users_ajax/?surname=${encodeURIComponent(searchTerm)}`);
                        const data = await response.json();
                        setUsers(data);
                        setError(null);
                    } catch (err) {
                        setError('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤');
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                }, 300);
                return () => clearTimeout(timer);
            } else {
                setUsers([]);
            }
        }, [searchTerm, isOpen]);

        const handleAssign = async (user) => {
            try {
                const workplaceId = `329-${workplaceNumber}`;
                const response = await fetch(`/api/classrooms/329/workplaces/${workplaceId}/assign/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: user.id }),
                });

                if (response.ok) {
                    onAssign();
                    onClose();
                    setSearchTerm('');
                } else {
                    const errorData = await response.json();
                    setError(errorData.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è');
                }
            } catch (err) {
                setError('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
                console.error(err);
            }
        };

        if (!isOpen) return null;

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –Ω–∞ Workplace {workplaceNumber}</h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>

                    {error && <div className="error-text">{error}</div>}

                    <input
                        type="text"
                        className="search-input"
                        placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        autoFocus
                    />

                    <div className="user-list">
                        {loading && <div className="loading-text">–ü–æ—à—É–∫...</div>}
                        {!loading && searchTerm.length < 2 && (
                            <div className="loading-text">–í–≤–µ–¥—ñ—Ç—å –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏</div>
                        )}
                        {!loading && users.length === 0 && searchTerm.length >= 2 && (
                            <div className="loading-text">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
                        )}
                        {!loading && users.map((user, idx) => (
                            <div
                                key={idx}
                                className="user-item"
                                onClick={() => handleAssign(user)}
                            >
                                {user.display}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    function ConfirmDeleteModal({ isOpen, onClose, placement, onConfirm }) {
        if (!isOpen || !placement) return null;

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è</h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>

                    <p style={{ color: 'var(--text-color)', marginBottom: '15px' }}>
                        –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è?
                    </p>
                    <p style={{ color: 'var(--primary-color)', fontWeight: 'bold' }}>
                        {placement.user.last_name} {placement.user.first_name}
                    </p>

                    <div className="confirm-buttons">
                        <button className="confirm-btn confirm-btn-no" onClick={onClose}>
                            –°–∫–∞—Å—É–≤–∞—Ç–∏
                        </button>
                        <button className="confirm-btn confirm-btn-yes" onClick={onConfirm}>
                            –í–∏–¥–∞–ª–∏—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    function ScreenshotModal({ isOpen, onClose, workplace }) {
        if (!isOpen || !workplace) return null;

        const imageUrl = `/api/classrooms/329/workplaces/${workplace.number}/screenshots/${workplace.last_screenshot_filename}/`;
        const timestamp = new Date(workplace.last_screenshot_at).toLocaleString('uk-UA');

        return (
            <div className="modal show" onClick={onClose}>
                <div className="modal-content" style={{ maxWidth: '900px', width: '95%' }} onClick={(e) => e.stopPropagation()}>
                    <div className="modal-header">
                        <h3 className="modal-title">–°–∫—Ä—ñ–Ω—à–æ—Ç Workplace {workplace.number}</h3>
                        <button className="close-btn" onClick={onClose}>&times;</button>
                    </div>
                    <div className="text-center mb-2 text-muted">{timestamp}</div>
                    <div style={{ textAlign: 'center', overflow: 'auto', maxHeight: '80vh' }}>
                        <img
                            src={imageUrl}
                            alt={`Screenshot ${workplace.number}`}
                            style={{ maxWidth: '100%', maxHeight: '70vh', border: '1px solid #ccc' }}
                        />
                    </div>
                </div>
            </div>
        );
    }

    function ClassroomApp() {
        const [classroomData, setClassroomData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [lastUpdated, setLastUpdated] = useState(null);

        // Filter state
        const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
        const [lesson, setLesson] = useState(null); // Will be fetched from server
        const [singles, setSingles] = useState(false);
        const [autoUpdate, setAutoUpdate] = useState(true); // Auto-update lesson
        const [screenshotsEnabled, setScreenshotsEnabled] = useState(true); // Screenshots toggle

        // Modal state
        const [modalOpen, setModalOpen] = useState(false);
        const [selectedWorkplace, setSelectedWorkplace] = useState(null);
        const [deleteModalOpen, setDeleteModalOpen] = useState(false);
        const [placementToDelete, setPlacementToDelete] = useState(null);
        const [screenshotModalOpen, setScreenshotModalOpen] = useState(false);
        const [screenshotWorkplace, setScreenshotWorkplace] = useState(null);

        const REFRESH_INTERVAL = 5000; // 5 seconds

        // Get current lesson from server on initial load
        useEffect(() => {
            const getCurrentLesson = async () => {
                if (!autoUpdate) {
                    // If auto-update is disabled, use fallback
                    if (!lesson) setLesson('0');
                    return;
                }

                try {
                    const response = await fetch('/api/classrooms/329/');
                    if (response.ok) {
                        const data = await response.json();
                        setLesson(data.lesson.toString());
                    } else {
                        setLesson('0'); // Fallback
                    }
                } catch (err) {
                    console.error('Error fetching current lesson:', err);
                    setLesson('0'); // Fallback
                }
            };
            getCurrentLesson();
        }, [autoUpdate]);

        // Adjust lesson when switching between paired/single mode
        useEffect(() => {
            if (!lesson) return;

            const lessonNum = parseInt(lesson);
            if (!singles && lessonNum % 2 === 1) {
                // Switching to paired mode and current lesson is odd (2,4,6,8)
                // Round down to the paired lesson (0,2,4,6)
                setLesson((lessonNum - 1).toString());
            }
        }, [singles]);

        const fetchClassroomData = useCallback(async () => {
            if (!lesson) return; // Don't fetch until lesson is initialized

            try {
                const params = new URLSearchParams({
                    date: date,
                    lesson: lesson,
                    singles: singles ? 'on' : 'off'
                });

                const response = await fetch(`/api/classrooms/329/?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                setClassroomData(data);
                setLastUpdated(new Date());
                setError(null);

                // Auto-update lesson if enabled and lesson has changed
                if (autoUpdate && data.lesson && data.lesson.toString() !== lesson) {
                    setLesson(data.lesson.toString());
                }

                // Update screenshots state from server
                if (data.screenshots_enabled !== undefined) {
                    setScreenshotsEnabled(data.screenshots_enabled);
                }
            } catch (err) {
                setError(err.message);
                console.error('Error fetching classroom data:', err);
            } finally {
                setLoading(false);
            }
        }, [date, lesson, singles, autoUpdate]);

        // Initial fetch and auto-refresh
        useEffect(() => {
            fetchClassroomData();
            const interval = setInterval(fetchClassroomData, REFRESH_INTERVAL);
            return () => clearInterval(interval);
        }, [fetchClassroomData]);

        const handleScreenshotClick = (workplace) => {
            setScreenshotWorkplace(workplace);
            setScreenshotModalOpen(true);
        };

        const handleCloseScreenshotModal = () => {
            setScreenshotModalOpen(false);
            setScreenshotWorkplace(null);
        };

        const formatTime = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
        };

        const formatLastUpdated = () => {
            if (!lastUpdated) return '';
            return lastUpdated.toLocaleTimeString('uk-UA', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        };

        const handleOpenModal = (workplaceNumber) => {
            setSelectedWorkplace(workplaceNumber);
            setModalOpen(true);
        };

        const handleCloseModal = () => {
            setModalOpen(false);
            setSelectedWorkplace(null);
        };

        const handleAssignSuccess = () => {
            fetchClassroomData();
        };

        const handleDeleteClick = (placement) => {
            setPlacementToDelete(placement);
            setDeleteModalOpen(true);
        };

        const handleDeleteConfirm = async () => {
            if (!placementToDelete) return;

            try {
                const response = await fetch(
                    `/api/classrooms/329/workplaces/${placementToDelete.workplace_id}/?placement_id=${placementToDelete.id}`,
                    { method: 'DELETE' }
                );

                if (response.ok) {
                    fetchClassroomData();
                    setDeleteModalOpen(false);
                    setPlacementToDelete(null);
                } else {
                    const errorData = await response.json();
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + (errorData.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
                }
            } catch (err) {
                alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + err.message);
                console.error(err);
            }
        };

        const handleDeleteCancel = () => {
            setDeleteModalOpen(false);
            setPlacementToDelete(null);
        };

        const handleScreenshotsToggle = async (enabled) => {
            try {
                const response = await fetch('/api/classrooms/329/screenshots/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ screenshots_enabled: enabled }),
                });

                if (response.ok) {
                    setScreenshotsEnabled(enabled);
                } else {
                    console.error('Failed to update screenshots setting');
                    // Revert on error
                    setScreenshotsEnabled(!enabled);
                }
            } catch (err) {
                console.error('Error updating screenshots setting:', err);
                // Revert on error
                setScreenshotsEnabled(!enabled);
            }
        };

        // Helper for rendering workplace card (to deduplicate code)
        const renderWorkplaceCard = (workplace) => (
            <div key={workplace.number} className="card text-center border-success mt-2">
                <div className="card-body pt-1 pb-1">
                    <h5 className="card-title" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', margin: '0' }}>
                        <span>Workplace {workplace.number}</span>
                        <div>
                            {workplace.last_screenshot_filename && (
                                <button
                                    className="assign-btn"
                                    onClick={() => handleScreenshotClick(workplace)}
                                    title={`–°–∫—Ä—ñ–Ω—à–æ—Ç: ${formatTime(workplace.last_screenshot_at)}`}
                                    style={{ padding: '2px 6px', fontSize: '12px', marginLeft: '4px', background: 'linear-gradient(45deg, #17a2b8, #138496)' }}
                                >
                                    üì∑
                                </button>
                            )}
                            <button
                                className="assign-btn"
                                onClick={() => handleOpenModal(workplace.number)}
                                title="–î–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞"
                                style={{ padding: '2px 6px', fontSize: '12px', marginLeft: '4px' }}
                            >
                                ‚ûï
                            </button>
                        </div>
                    </h5>
                    {workplace.placements.map(placement => (
                        <div key={placement.id} className="placement-row">
                            <span>
                                {placement.user.last_name} {placement.user.first_name}{' '}
                                <span className="text-success">
                                    {formatTime(placement.created_at)}
                                </span>
                            </span>
                            <button
                                className="delete-btn"
                                onClick={() => handleDeleteClick(placement)}
                                title="–í–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è"
                            >
                                ‚ùå
                            </button>
                            <br />
                        </div>
                    ))}
                </div>
            </div>
        );

        return (
            <div className="container mt-3">
                <AssignmentModal
                    isOpen={modalOpen}
                    onClose={handleCloseModal}
                    workplaceNumber={selectedWorkplace}
                    onAssign={handleAssignSuccess}
                />

                <ConfirmDeleteModal
                    isOpen={deleteModalOpen}
                    onClose={handleDeleteCancel}
                    placement={placementToDelete}
                    onConfirm={handleDeleteConfirm}
                />

                <ScreenshotModal
                    isOpen={screenshotModalOpen}
                    onClose={handleCloseScreenshotModal}
                    workplace={screenshotWorkplace}
                />

                {/* Filters */}
                <div className="row mb-4 g-3">
                    {/* ... (filters same) ... */}
                    <div className="col-md-2">
                        <label htmlFor="dateFilter" className="form-label">–û–±—Ä–∞—Ç–∏ –¥–∞—Ç—É:</label>
                        <input
                            type="date"
                            id="dateFilter"
                            className="form-control"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                        />

                        <label htmlFor="lessonFilter" className="form-label mt-2">–£—Ä–æ–∫:</label>
                        <select
                            id="lessonFilter"
                            className="form-select"
                            value={lesson}
                            onChange={(e) => setLesson(e.target.value)}
                        >
                            {singles
                                ? [0, 1, 2, 3, 4, 5, 6, 7].map(num => (
                                    <option key={num} value={num}>{num + 1} —É—Ä–æ–∫</option>
                                ))
                                : [0, 2, 4, 6].map(num => (
                                    <option key={num} value={num}>{num + 1}-{num + 2} —É—Ä–æ–∫–∏</option>
                                ))
                            }
                        </select>

                        <div className="form-check mt-2">
                            <input
                                type="checkbox"
                                id="pairFilter"
                                className="form-check-input"
                                checked={singles}
                                onChange={(e) => setSingles(e.target.checked)}
                            />
                            <label htmlFor="pairFilter" className="form-check-label">
                                –û–¥–∏–Ω–æ—á–Ω—ñ —É—Ä–æ–∫–∏
                            </label>
                        </div>

                        <div className="form-check mt-2">
                            <input
                                type="checkbox"
                                id="autoUpdateFilter"
                                className="form-check-input"
                                checked={!autoUpdate}
                                onChange={(e) => setAutoUpdate(!e.target.checked)}
                            />
                            <label htmlFor="autoUpdateFilter" className="form-check-label">
                                –ù–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏
                            </label>
                        </div>

                        <div className="form-check mt-2">
                            <input
                                type="checkbox"
                                id="screenshotsFilter"
                                className="form-check-input"
                                checked={screenshotsEnabled}
                                onChange={(e) => handleScreenshotsToggle(e.target.checked)}
                            />
                            <label htmlFor="screenshotsFilter" className="form-check-label">
                                –°–∫—Ä—ñ–Ω—à–æ—Ç–∏ —É–≤—ñ–º–∫–Ω–µ–Ω—ñ
                            </label>
                        </div>

                        {lastUpdated && (
                            <div className="mt-3 text-muted small">
                                –û–Ω–æ–≤–ª–µ–Ω–æ: {formatLastUpdated()}
                            </div>
                        )}
                    </div>

                    <div className="col-md-7">
                        <h1>–ö–∞–±—ñ–Ω–µ—Ç 329</h1>

                        <div className="row">
                            {/* Left column (workplaces 10-18) */}
                            <div className="col-md-6">
                                {classroomData?.workplaces_2?.map(workplace => renderWorkplaceCard(workplace))}
                            </div>

                            {/* Right column (workplaces 9-1) */}
                            <div className="col-md-6">
                                {classroomData?.workplaces_1?.map(workplace => renderWorkplaceCard(workplace))}
                            </div>
                        </div>
                    </div>

                    <div className="col-md-3">
                        <div className="card text-center border-primary">
                            <div className="card-body">
                                <h5 className="card-title">–ü–æ—Ç–æ—á–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏</h5>
                                <p className="card-text">
                                    –£—Ä–æ–∫–∏ –∑ {classroomData?.lesson_from} –¥–æ {classroomData?.lesson_to}
                                </p>
                                <p>
                                    {classroomData?.lesson_start && formatTime(classroomData.lesson_start)} -<br />
                                    {classroomData?.lesson_end && formatTime(classroomData.lesson_end)}
                                </p>
                            </div>
                        </div>

                        <div className="alert alert-primary mt-3">
                            <strong>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —É —Å–∏—Å—Ç–µ–º—ñ:</strong>{' '}
                            <span id="studentsCount">{classroomData?.unique_users_count || 0}</span>
                        </div>

                        {/* User names list */}
                        <div className="list-group mt-3">
                            {classroomData?.usernames?.map((username, idx) => (
                                <div key={idx} className="list-group-item list-group-item-action">
                                    {username}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('classroom-root'));
    root.render(<ClassroomApp />);
    {% endverbatim %}
</script>

{% endblock %}